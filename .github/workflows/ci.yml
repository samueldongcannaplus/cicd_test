name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  lint_soft:
    # Run on feature branches + PRs (non-main)
    if: github.ref_name != 'main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install -r requirements.txt
      - run: pip install pylint mypy flake8

      # Soft checks
      - name: pylint (soft)
        run: python -m pylint --disable=fixme .
        continue-on-error: true
      - name: mypy (soft)
        run: python -m mypy --disable-error-code=import-untyped .
        continue-on-error: true
      - name: flake8 (soft)
        run: python -m flake8 . --max-line-length=99
        continue-on-error: true

      # Fail on tests
      - name: unit tests
        run: python -m unittest -v unit_tests.py

  lint_strict:
    # Run on main (strict)
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install -r requirements.txt
      - run: pip install pylint mypy flake8
            
      - name: Azure login
        uses: azure/login@v2 
        with: 
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Prove az is logged in
        run: az account show

      # Strict checks
      - name: pylint (strict)
        run: python -m pylint --disable=fixme .
      - name: mypy (strict)
        run: python -m mypy --disable-error-code=import-untyped .
      - name: flake8 (strict)
        run: python -m flake8 . --max-line-length=99

      - name: unit tests
        run: python -m unittest -v unit_tests.py
